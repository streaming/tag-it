(function(b){b.widget("ui.tagit",{options:{allowDuplicates:!1,caseSensitive:!0,fieldName:"tags",placeholderText:null,readOnly:!1,removeConfirmation:!1,tagLimit:null,availableTags:[],autocomplete:{},showAutocompleteOnFocus:!1,showAutocompleteAfterTagManipulation:!0,hidePlaceholderOnVisibleTags:!1,onlyAllowAutoCompleteTags:!1,allowSpaces:!1,singleField:!1,singleFieldDelimiter:",",singleFieldNode:null,animate:!0,tabIndex:null,beforeTagAdded:null,afterTagAdded:null,beforeTagRemoved:null,afterTagRemoved:null,
onTagClicked:null,onTagLimitExceeded:null,onTagAdded:null,onTagRemoved:null,tagSource:null},_removingTag:!1,_create:function(){var a=this;this.element.is("input")?(this.tagList=b("<ul></ul>").insertAfter(this.element),this.options.singleField=!0,this.options.singleFieldNode=this.element,this.element.css("display","none")):this.tagList=this.element.find("ul, ol").addBack().last();this.tagInput=b('<input type="text" />').addClass("ui-widget-content");this.options.readOnly&&this.tagInput.attr("disabled",
"disabled");this.options.tabIndex&&this.tagInput.attr("tabindex",this.options.tabIndex);this.options.placeholderText&&this.tagInput.attr("placeholder",this.options.placeholderText);this.options.autocomplete.source||(this.options.autocomplete.source=function(a,d){var c=a.term.toLowerCase(),e=b.grep(this.options.availableTags,function(a){return 0===a.toLowerCase().indexOf(c)});d(this._subtractArray(e,this.assignedTags()))});this.options.showAutocompleteOnFocus&&(this.tagInput.focus(function(){(a.options.showAutocompleteAfterTagManipulation||
!a._removingTag)&&a._showAutocomplete()}),"undefined"===typeof this.options.autocomplete.minLength&&(this.options.autocomplete.minLength=0));b.isFunction(this.options.autocomplete.source)&&(this.options.autocomplete.source=b.proxy(this.options.autocomplete.source,this));b.isFunction(this.options.tagSource)&&(this.options.tagSource=b.proxy(this.options.tagSource,this));this.tagList.addClass("tagit").addClass("ui-widget ui-widget-content ui-corner-all").append(b('<li class="tagit-new"></li>').append(this.tagInput)).click(function(c){var d=
b(c.target);d.hasClass("tagit-label")?(d=d.closest(".tagit-choice"),d.hasClass("removed")||a._trigger("onTagClicked",c,{tag:d,tagLabel:a.tagLabel(d)})):a.tagInput.focus()});var c=!1;if(this.options.singleField)if(this.options.singleFieldNode){var e=b(this.options.singleFieldNode),f=e.val().split(this.options.singleFieldDelimiter);e.val("");b.each(f,function(b,d){a.createTag(d,null,!0);c=!0})}else this.options.singleFieldNode=b('<input type="hidden" style="display:none;" value="" name="'+this.options.fieldName+
'" />'),this.tagList.after(this.options.singleFieldNode);c||this.tagList.children("li").each(function(){b(this).hasClass("tagit-new")||(a.createTag(b(this).text(),b(this).attr("class"),!0),b(this).remove())});this.tagInput.keydown(function(c){if(c.which==b.ui.keyCode.BACKSPACE&&""===a.tagInput.val()){var d=a._lastTag();!a.options.removeConfirmation||d.hasClass("remove")?a.removeTag(d):a.options.removeConfirmation&&d.addClass("remove ui-state-highlight");a.tagInput.autocomplete("close")}else a.options.removeConfirmation&&
a._lastTag().removeClass("remove ui-state-highlight");if(c.which===b.ui.keyCode.COMMA||c.which===b.ui.keyCode.ENTER||c.which===b.ui.keyCode.TAB&&""!==a.tagInput.val()||c.which==b.ui.keyCode.SPACE&&!0!==a.options.allowSpaces&&('"'!=b.trim(a.tagInput.val()).replace(/^s*/,"").charAt(0)||'"'==b.trim(a.tagInput.val()).charAt(0)&&'"'==b.trim(a.tagInput.val()).charAt(b.trim(a.tagInput.val()).length-1)&&0!==b.trim(a.tagInput.val()).length-1))!(c.which===b.ui.keyCode.ENTER&&""===a.tagInput.val())&&(c.which===
b.ui.keyCode.TAB&&!a.options.onlyAllowAutoCompleteTags)&&c.preventDefault(),a.createTag(a._cleanedInput())?c.which===b.ui.keyCode.TAB&&c.preventDefault():a.options.onlyAllowAutoCompleteTags&&a.tagInput.val(""),a.tagInput.autocomplete("close")}).blur(function(){a.tagInput.data("autocomplete-open")||a.createTag(a._cleanedInput())});if(this.options.availableTags||this.options.tagSource||this.options.autocomplete.source)e={select:function(b,c){a.createTag(c.item.value);return!1}},b.extend(e,this.options.autocomplete),
e.source=this.options.tagSource||e.source,this.tagInput.autocomplete(e).bind("autocompleteopen",function(){a.tagInput.data("autocomplete-open",!0)}).bind("autocompleteclose",function(){a.tagInput.data("autocomplete-open",!1)})},_cleanedInput:function(){return b.trim(this.tagInput.val().replace(/^"(.*)"$/,"$1"))},_lastTag:function(){return this.tagList.find(".tagit-choice:last:not(.removed)")},_tags:function(){return this.tagList.find(".tagit-choice:not(.removed)")},assignedTags:function(){var a=this,
c=[];this.options.singleField?(c=b(this.options.singleFieldNode).val().split(this.options.singleFieldDelimiter),""===c[0]&&(c=[])):this._tags().each(function(){c.push(a.tagLabel(this))});return c},_updateSingleTagsField:function(a){b(this.options.singleFieldNode).val(a.join(this.options.singleFieldDelimiter)).trigger("change")},_subtractArray:function(a,c){for(var e=[],f=0;f<a.length;f++)-1==b.inArray(a[f],c)&&e.push(a[f]);return e},tagLabel:function(a){return this.options.singleField?b(a).find(".tagit-label:first").text():
b(a).find("input:first").val()},_showAutocomplete:function(){this.tagInput.autocomplete("search","")},_findTagByLabel:function(a){var c=this,e=null;this._tags().each(function(){if(c._formatStr(a)==c._formatStr(c.tagLabel(this)))return e=b(this),!1});return e},_isNew:function(a){return!this._findTagByLabel(a)},_formatStr:function(a){return this.options.caseSensitive?a:b.trim(a.toLowerCase())},_effectExists:function(a){return Boolean(b.effects&&(b.effects[a]||b.effects.effect&&b.effects.effect[a]))},
createTag:function(a,c,e){var f=this;a=b.trim(a);if(""===a)return!1;if(!this.options.allowDuplicates&&!this._isNew(a))return a=this._findTagByLabel(a),!1!==this._trigger("onTagExists",null,{existingTag:a,duringInitialization:e})&&this._effectExists("highlight")&&a.effect("highlight"),!1;if(this.options.tagLimit&&this._tags().length>=this.options.tagLimit)return this._trigger("onTagLimitExceeded",null,{duringInitialization:e}),!1;var g=b(this.options.onTagClicked?'<a class="tagit-label"></a>':'<span class="tagit-label"></span>').text(a),
d=b("<li></li>").addClass("tagit-choice ui-widget-content ui-state-default ui-corner-all").addClass(c).append(g);if(this.options.readOnly)d.addClass("tagit-choice-read-only");else{d.addClass("tagit-choice-editable");var h=b("<span></span>").addClass("ui-icon ui-icon-close"),h=b('<a><span class="text-icon">\u00d7</span></a>').addClass("tagit-close").append(h).click(function(){f.removeTag(d)});d.append(h)}this.options.singleField||(g=g.html(),d.append('<input type="hidden" style="display:none;" value="'+
g+'" name="'+this.options.fieldName+'" />'));var j=this.tagLabel(d);if(!1===this._trigger("beforeTagAdded",null,{tag:d,tagLabel:j,duringInitialization:e}))return!1;if(this.options.onlyAllowAutoCompleteTags&&0<this.options.availableTags.length){for(var g=-1,h=!1,k=0;k<this.options.availableTags.length;k++){var l=this.options.availableTags[k];j===l?h=!0:!this.options.caseSensitive&&j.toLowerCase()===l.toLowerCase()&&(g=k)}0<=g&&!h&&(j=this.options.availableTags[g],b(".tagit-label",d).text(j),b("input",
d).attr("value",j));if(-1===g&&!h&&!d.hasClass(c))return!1}this.options.singleField&&(c=this.assignedTags(),c.push(a),this._updateSingleTagsField(c));this._trigger("onTagAdded",null,d);this.tagInput.val("");this.tagInput.parent().before(d);this._trigger("afterTagAdded",null,{tag:d,tagLabel:this.tagLabel(d),duringInitialization:e});this.options.showAutocompleteOnFocus&&(!e&&this.options.showAutocompleteAfterTagManipulation)&&setTimeout(function(){f._showAutocomplete()},0);this.options.placeholderText&&
this.options.hidePlaceholderOnVisibleTags&&this.tagInput.removeAttr("placeholder");return!0},removeTag:function(a,c){var e=this;c="undefined"===typeof c?this.options.animate:c;a=b(a);this._removingTag=!0;this._trigger("onTagRemoved",null,a);if(!1!==this._trigger("beforeTagRemoved",null,{tag:a,tagLabel:this.tagLabel(a)})){if(this.options.singleField){var f=this.assignedTags(),g=this.tagLabel(a),f=b.grep(f,function(a){return a!=g});this._updateSingleTagsField(f)}c?(a.addClass("removed"),f=this._effectExists("blind")?
["blind",{direction:"horizontal"},"fast"]:["fast"],f.push(function(){a.remove()}),a.fadeOut("fast",function(){e._removingTag=!1}).hide.apply(a,f).dequeue()):(a.remove(),this._removingTag=!1);this._trigger("afterTagRemoved",null,{tag:a,tagLabel:this.tagLabel(a)});this.options.placeholderText&&(!this.tagInput.attr("placeholder")&&0===this._tags().length)&&this.tagInput.attr("placeholder",this.options.placeholderText)}},removeTagByLabel:function(a,b){var e=this._findTagByLabel(a);if(!e)throw"No such tag exists with the name '"+
a+"'";this.removeTag(e,b)},removeAll:function(){var a=this;this._tags().each(function(b,e){a.removeTag(e,!1)})}})})(jQuery);